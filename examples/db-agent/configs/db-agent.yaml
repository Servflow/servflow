# Database Agent API Example
# This example demonstrates how to build an AI-powered database agent endpoint
# that allows users to interact with your database using natural language queries.

# API Endpoint Configuration
id: db_agent
name: Database Agent API

http:
  listenPath: /db_agent
  method: POST
  next: conditional.validate

conditionals:
  validate:
    expression: |
      {{ notempty (param "query") "Query" true }}
    validPath: action.agent
    invalidPath: response.400

actions:
  agent:
    type: agent
    config:
      integrationID: my_openai_service
      userPrompt: '{{ param "query" }}'
      systemPrompt: |
        You are a helpful agent to assist the user interact and query data from a mongodb database.
        You have access to a mongodb querier tool that allows you fetch data using filter and projection queries on the collection "users".
        The collection has the fields name, email, id (uuid).
        *IMPORTANT* Never include password queries in your responses
      toolConfigs:
        - type: workflow
          workflowConfig:
            name: mongodbquerier
            description: |
              Accepts a filter query in the form of json and a projection in the form of json and performs queries on the collection "users"
            params: ["filter", "projection"]
            returnValue: "{{ jsonout .variable_actions_queryDB}}"
            start: "action.queryDB"
      history: true
    next: response.200

  queryDB:
    type: mongoquery
    config:
      collection: users
      filter: '{{ tool_param "filter" | stringescape }}'
      projection: '{{ tool_param "projection" | stringescape }}'
      integrationID: "my_database"

responses:
  "200":
    code: 200
    responseObject:
      fields:
        response:
          value: "{{ .variable_actions_agent }}"

  "400":
    code: 400
    responseObject:
      fields:
        success:
          value: false
        message:
          value: "Query parameter is required"
        errors:
          value: ["Missing or empty 'query' parameter"]
